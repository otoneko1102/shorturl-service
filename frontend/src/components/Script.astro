---
---
<script>
const footer = document.getElementsByTagName("footer")[0];
const form = document.getElementById("shorten-form");
const urlInput = document.getElementById("url-input") as HTMLInputElement;
const aliasInput = document.getElementById("alias-input") as HTMLInputElement;
const resultArea = document.getElementById("result-area");
const submitButton = document.getElementById("submit-button") as HTMLButtonElement;
const clearButton = document.getElementById("clear-button") as HTMLButtonElement;

const captchaModal = document.getElementById("captcha-modal");
const captchaImageContainer = document.getElementById("captcha-image");
const captchaOptionsContainer = document.getElementById("captcha-options");
const captchaCancelButton = document.getElementById("captcha-cancel");
const captchaError = document.getElementById("captcha-error");

document.addEventListener("DOMContentLoaded", () => {
  const repo = document.createElement("a");
  repo.textContent = "GitHub Repo";
  repo.href = "https://github.com/otoneko1102/shorturl-service";
  repo.target = "_blank";
  footer.appendChild(repo);
});

let captchaToken = "";

function resetSubmitButton() {
  submitButton.textContent = "短縮する";
  submitButton.disabled = false;
}

async function fetchAndShowCaptcha() {
  submitButton.textContent = "認証中...";
  submitButton.disabled = true;
  captchaError.textContent = "";
  captchaImageContainer.innerHTML = "読み込み中...";
  captchaOptionsContainer.innerHTML = "";

  try {
    const response = await fetch("/api/captcha");
    if (!response.ok) {
      throw new Error("CAPTCHAの取得に失敗しました。");
    }
    const data = await response.json();

    captchaToken = data.token;
    captchaImageContainer.innerHTML = data.image;

    data.options.forEach((optionText) => {
      const button = document.createElement("button");
      button.textContent = optionText;
      button.type = "button";
      button.classList.add("captcha-option-button");
      button.addEventListener("click", () => {
        submitShortenRequest(optionText);
      });
      captchaOptionsContainer.appendChild(button);
    });

    captchaModal.style.display = "flex";
    resetSubmitButton();
    submitButton.textContent = "認証中...";
    submitButton.disabled = true;
  } catch (error) {
    displayError(error.message);
    resetSubmitButton();
  }
}

async function submitShortenRequest(captchaAnswer) {
  submitButton.textContent = "生成中...";
  submitButton.disabled = true;
  captchaModal.style.display = "none";

  try {
    // @ts-ignore
    nonstress.generateToken();
    // @ts-ignore
    const token = await nonstress.getToken();
    const response = await fetch("/api/create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        url: urlInput.value,
        alias: aliasInput.value || null,
        captchaToken: captchaToken,
        captchaAnswer: captchaAnswer,
        token,
      }),
    });

    const data = await response.json();

    if (response.ok) {
      displaySuccess(data.url);
    } else {
      const errorMessage =
        data.error?.message || "不明なエラーが発生しました。";
      displayError(errorMessage);
    }
  } catch (error) {
    displayError(error.message || "サーバーとの通信に失敗しました。");
  } finally {
    resetSubmitButton();
    aliasInput.value = "";
  }
}

form.addEventListener("submit", (e) => {
  e.preventDefault();
  if (!urlInput.value.trim()) {
    displayError("URLを入力してください。");
    return;
  }
  resultArea.innerHTML = "";
  fetchAndShowCaptcha();
});

clearButton.addEventListener("click", () => {
  urlInput.value = "";
  aliasInput.value = "";
  resultArea.innerHTML = "";
});

captchaCancelButton.addEventListener("click", () => {
  captchaModal.style.display = "none";
  resetSubmitButton();
});

window.addEventListener("click", (e) => {
  if (e.target === captchaModal) {
    captchaModal.style.display = "none";
    resetSubmitButton();
  }
});

function displaySuccess(shortUrl) {
  resultArea.innerHTML = `
    <div class="result-success">
      <p>短縮URLを生成しました！</p>
      <div class="short-url-box">
        <a href="${shortUrl}" target="_blank">${shortUrl}</a>
        <button id="copy-button">コピー</button>
      </div>
    </div>
  `;
  const copyButton = document.getElementById("copy-button") as HTMLButtonElement;
  const fallbackCopy = (text) => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.top = "-9999px";
    textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand("copy");
      const originalText = copyButton.textContent;
      copyButton.textContent = "完了！";
      copyButton.disabled = true;
      setTimeout(() => {
        copyButton.textContent = "コピー";
        copyButton.disabled = false;
      }, 2000);
    } catch (err) {
      console.error("Fallback copy failed", err);
      alert("コピーに失敗しました。");
    }
    document.body.removeChild(textArea);
  };

  copyButton.addEventListener("click", () => {
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard
        .writeText(shortUrl)
        .then(() => {
          const originalText = copyButton.textContent;
          copyButton.textContent = "完了！";
          copyButton.disabled = true;
          setTimeout(() => {
            copyButton.textContent = "コピー";
            copyButton.disabled = false;
          }, 2000);
        })
        .catch((err) => {
          console.error("Copy failed", err);
          fallbackCopy(shortUrl);
        });
    } else {
      fallbackCopy(shortUrl);
    }
  });
}

function displayError(message) {
  resultArea.innerHTML = `<div class="result-error">${message}</div>`;
}
</script>
